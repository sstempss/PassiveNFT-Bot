#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
PassiveNFT Bot - –ò–¢–û–ì–û–í–ê–Ø –í–ï–†–°–ò–Ø –° –ü–û–õ–ù–´–ú–ò –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ú–ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø–ú–ò

üîß –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò:
‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –æ—à–∏–±–∫–∞ "ExtBot is not properly initialized"
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ start()
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ webhook —Å —Ç–∞–π–º–∞—É—Ç–æ–º
‚úÖ –£–±—Ä–∞–Ω—ã RuntimeWarning –¥–ª—è coroutines
‚úÖ –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ _initialized —Ñ–ª–∞–≥–∞

üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò:
‚ö° –ú–ì–ù–û–í–ï–ù–ù–´–ï –æ—Ç–≤–µ—Ç—ã –Ω–∞ /start (0.1-0.5 —Å–µ–∫—É–Ω–¥—ã –≤–º–µ—Å—Ç–æ 30-60 —Å–µ–∫—É–Ω–¥)
üöÄ –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î 
üíæ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (5 –º–∏–Ω—É—Ç TTL)
üõ°Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞—â–∏—Ç–∞ (1 —Å–µ–∫ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö, 5 —Å–µ–∫ –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö)
üîÑ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ callback –∫–Ω–æ–ø–∫–∏

–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ add_referral
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ pending_referrals –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–π —Ä–µ—Ñ–µ—Ä–µ—Ä–∞–º (10%)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è get_user_referral_stats —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- –ò–°–ü–†–ê–í–õ–ï–ù–´ –≠–ú–û–î–ó–ò –í F-–°–¢–†–û–ö–ê–• (SyntaxError)
- –î–û–ë–ê–í–õ–ï–ù–´ –ö–û–ú–ê–ù–î–´ /channel_info, /get_channel_id, /testcmd
- –ò–°–ü–†–ê–í–õ–ï–ù–ê –ü–†–û–ë–õ–ï–ú–ê –° PARSING MARKDOWN - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
- –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ê –°–ò–°–¢–ï–ú–ê /confirmpay –¥–ª—è –±–µ—Å–ø–µ—Ä–µ–±–æ–π–Ω–æ–π —Ä–∞–±–æ—Ç—ã
"""

import asyncio
import logging
import sys
import traceback
import time
from pathlib import Path
from typing import Optional
from datetime import datetime, timedelta
import re

# –ò–º–ø–æ—Ä—Ç—ã Telegram –±–æ—Ç–∞
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
from telegram.error import BadRequest, TelegramError
import httpx

# –ò–ú–ü–û–†–¢–´ –í–ï–ë-–°–ï–†–í–ï–†–ê –£–î–ê–õ–ï–ù–´ - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ polling
import os

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
from database_async import AsyncDatabaseManager

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

# ==============================================================================
# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1: –ö–ï–®–ò–†–û–í–ê–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
# ==============================================================================

class UserCache:
    """–ö–µ—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    
    def __init__(self, ttl_seconds=300):  # 5 –º–∏–Ω—É—Ç TTL
        self.cache: dict = {}
        self.ttl = ttl_seconds
    
    def get(self, user_id: int) -> Optional[dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–µ—à–∞"""
        if user_id in self.cache:
            data = self.cache[user_id]
            if datetime.now() - data['timestamp'] < timedelta(seconds=self.ttl):
                return data['user']
            else:
                del self.cache[user_id]  # –£–¥–∞–ª–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ
        return None
    
    def set(self, user_id: int, user_data: dict):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–µ—à"""
        self.cache[user_id] = {
            'user': user_data,
            'timestamp': datetime.now()
        }
    
    def invalidate(self, user_id: int):
        """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.cache:
            del self.cache[user_id]

# –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–Ø –î–õ–Ø MARKDOWN
def escape_markdown(text):
    """–£–ª—É—á—à–µ–Ω–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ Markdown –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞"""
    if text is None:
        return ""
    
    text = str(text)
    
    # –£–õ–£–ß–®–ï–ù–ù–´–ï –ø–∞—Ä—ã —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - –ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!
    escape_pairs = [
        ('\\', '\\\\'),  # –°–Ω–∞—á–∞–ª–∞ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏
        ('*', '\\*'),      # –ñ–∏—Ä–Ω—ã–π/–∫—É—Ä—Å–∏–≤
        ('_', '\\_'),      # –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
        ('[', '\\['),      # –°—Å—ã–ª–∫–∞
        (']', '\\]'),      # –°—Å—ã–ª–∫–∞  
        ('(', '\\('),      # –°—Å—ã–ª–∫–∞
        (')', '\\)'),      # –°—Å—ã–ª–∫–∞
        ('~', '\\~'),      # –ó–∞—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
        ('`', '\\`'),      # –ö–æ–¥
        ('>', '\\>'),      # –¶–∏—Ç–∞—Ç–∞
        ('#', '\\#'),      # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        ('+', '\\+'),      # –°–ø–∏—Å–æ–∫
        ('-', '\\-'),      # –°–ø–∏—Å–æ–∫
        ('=', '\\='),      # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        ('|', '\\|'),      # –¢–∞–±–ª–∏—Ü–∞
        ('{', '\\{'),      # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        ('}', '\\}'),      # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        ('.', '\\.'),      # –ö–æ–Ω–µ—Ü –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        ('!', '\\!'),      # –í–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–µ
    ]
    
    for char, escaped in escape_pairs:
        text = text.replace(char, escaped)
    
    return text

def safe_format_user_data(text, **kwargs):
    """–£–ª—É—á—à–µ–Ω–Ω–æ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö"""
    try:
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
        safe_kwargs = {}
        for key, value in kwargs.items():
            if isinstance(value, str):
                safe_kwargs[key] = escape_markdown(value)
            else:
                # –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Ç–∞–∫–∂–µ –ø—Ä–∏–º–µ–Ω—è–µ–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏
                safe_kwargs[key] = escape_markdown(str(value))
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        result = text.format(**safe_kwargs)
        return result
        
    except KeyError as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á: {e}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        return f"–û–®–ò–ë–ö–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø: {text}\n–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {kwargs}"
    except Exception as e:
        logger.error(f"–û–±—â–∞—è –æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        return f"–û–ë–©–ê–Ø –û–®–ò–ë–ö–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø: {text}\n–û—à–∏–±–∫–∞: {e}"

class SafeConfig:
    """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞"""
    def __init__(self):
        # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        self.BOT_TOKEN = self._get_env_var('BOT_TOKEN', '8530441136:AAHto3A4Zqa5FnGG01cxL6SvU3jW8_Ai0iI')
        self.ADMIN_USER_IDS = [8387394503, 2112739781] # pro.player.egor

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ TON –∫–æ—à–µ–ª—å–∫–∞
        self.TON_WALLET_ADDRESS = self._get_env_var('TON_WALLET_ADDRESS', 'UQAij8pQ3HhdBn3lw6n9Iy2toOH9OMcBuL8yoSXTNpLJdfZJ')
        self.MANAGER_USERNAME = self._get_env_var('MANAGER_USERNAME', 'num6er9')
        self.BOT_USERNAME = self._get_env_var('BOT_USERNAME', 'passivenft_bot')
        
        # STARS_USERNAME
        self.STARS_USERNAME = self._get_env_var('STARS_USERNAME', 'pingvinchik_liza')

        # MAPPING –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è Stars –ø–ª–∞—Ç–µ–∂–µ–π
        self.CHANNEL_MAPPINGS = {
            25: -1001234567891,
            50: -1001234567892,
            75: -1001234567893,
            100: -1001234567894,
            150: -1001234567895,
            200: -1001234567896,
            250: -1001234567897
        }

        # TON_CHANNEL_MAPPINGS –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
        self.TON_CHANNEL_MAPPINGS = {
            150: -1001234567898,
            100: -1001234567899,
            50: -1001234567900
        }

        # STARS_CHANNEL_MAPPINGS –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
        self.STARS_CHANNEL_MAPPINGS = {
            -1002755746127: "Stars Channel 1",
            -1003223397887: "Stars Channel 2", 
            -1003232732123: "Stars Channel 3",
            -1003361243296: "Stars Channel 4"
        }

        # TON_CHANNEL_INVITE_LINKS –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
        self.TON_CHANNEL_INVITE_LINKS = [
            "https://t.me/+4BhdYzF2U65hOTIy",
            "https://t.me/+O7KaTknXPDVlMjY6", 
            "https://t.me/+LaQZfJHeQPcyNjUy"
        ]

        # STARS_CHANNEL_INVITE_LINKS –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
        self.STARS_CHANNEL_INVITE_LINKS = [
            "https://t.me/+xLVbmqzc3Dk2NWM6",
            "https://t.me/+uxH6Ot8Kyu4wZDk6",
            "https://t.me/+diQh7MowVhIwYzVi",
            "https://t.me/+6XnGRwJd8rY2ZGUy"
        ]

        # PRIVATE_CHANNEL_LINKS –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã /confirmpay
        self.PRIVATE_CHANNEL_LINKS = {
            "25_stars": "https://t.me/+xLVbmqzc3Dk2NWM6",
            "50_stars": "https://t.me/+uxH6Ot8Kyu4wZDk6", 
            "75_stars": "https://t.me/+diQh7MowVhIwYzVi",
            "100_stars": "https://t.me/+6XnGRwJd8rY2ZGUy",
            "150_stars": "https://t.me/+LaQZfJHeQPcyNjUy",
            "50_ton": "https://t.me/+4BhdYzF2U65hOTIy",
            "100_ton": "https://t.me/+O7KaTknXPDVlMjY6",
            "150_ton": "https://t.me/+LaQZfJHeQPcyNjUy"
        }

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫
        self.SUBSCRIPTION_PLANS = [
            {
                "name": "–Ω–∞ 150 —á–µ–ª–æ–≤–µ–∫",
                "description": """üñºÔ∏è 5 NFT –≤ –î–ï–ù–¨, 4 –≥–∏—Ñ—Ç–∞ –≤ –î–ï–ù–¨ üñºÔ∏è
                
üìÖ 150 NFT –≤ –ú–ï–°–Ø–¶, 120 –≥–∏—Ñ—Ç–æ–≤ –≤ –ú–ï–°–Ø–¶

üìä –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 0,67% –Ω–∞ –æ–¥–Ω–æ NFT, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ–º—ã—Ö NFT –≤ –¥–µ–Ω—å ‚Äì 5, —Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ 5*0,67% = 3,35% –Ω–∞ –ø–æ–±–µ–¥—É –∑–∞ –¥–µ–Ω—å, –≤ –º–µ—Å—è—Ü –ø–æ–ª—É—á–∞–µ—Ç—Å—è 100,5%

üéÅ –ù–∞ –≥–∏—Ñ—Ç—ã –∑–∞ –∑–≤–µ–∑–¥—ã –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥—ã –Ω–∞ –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 0,67%, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ–º—ã—Ö –≥–∏—Ñ—Ç–æ–≤ –≤ –¥–µ–Ω—å ‚Äì 4, —Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ 4*0,67% = 2,68% –Ω–∞ –ø–æ–±–µ–¥—É –∑–∞ –¥–µ–Ω—å, –≤ –º–µ—Å—è—Ü –ø–æ–ª—É—á–∞–µ—Ç—Å—è 80,4%

üí∞ –æ–∫—É–ø –æ—Ç —Ö1 –¥–æ —Ö5""",
                "price_ton": 4
            },
            {
                "name": "–Ω–∞ 100 —á–µ–ª–æ–≤–µ–∫",
                "description": """üñºÔ∏è 6 NFT –≤ –¥–µ–Ω—å, 4 –≥–∏—Ñ—Ç–∞ –≤ –¥–µ–Ω—å üñºÔ∏è
                
üìÖ 180 NFT –≤ –º–µ—Å—è—Ü, 120 –≥–∏—Ñ—Ç–æ–≤ –≤ –º–µ—Å—è—Ü

üìä –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 1% –Ω–∞ –æ–¥–Ω–æ NFT, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ–º—ã—Ö NFT –≤ –¥–µ–Ω—å ‚Äì 6, —Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ 6*1% = 6% –Ω–∞ –ø–æ–±–µ–¥—É –∑–∞ –¥–µ–Ω—å, –≤ –º–µ—Å—è—Ü –ø–æ–ª—É—á–∞–µ—Ç—Å—è 180%

üéÅ –ù–∞ –≥–∏—Ñ—Ç—ã –∑–∞ –∑–≤–µ–∑–¥—ã –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥—ã –Ω–∞ –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 0,67%, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ–º—ã—Ö –≥–∏—Ñ—Ç–æ–≤ –≤ –¥–µ–Ω—å ‚Äì 4, —Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ 4*1% = 4% –Ω–∞ –ø–æ–±–µ–¥—É –∑–∞ –¥–µ–Ω—å, –≤ –º–µ—Å—è—Ü –ø–æ–ª—É—á–∞–µ—Ç—Å—è 120%

üíµ –û–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –≤ 50% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –º–µ—Å—è—Ü (–≤ —Ä–∞–∑–º–µ—Ä–µ 1 NFT+–≥–∏—Ñ—Ç –∑–∞ 50 –∑–≤.)

üí∞ –æ–∫—É–ø –æ—Ç —Ö1 –¥–æ —Ö8""",
                "price_ton": 7
            },
            {
                "name": "–Ω–∞ 50 —á–µ–ª–æ–≤–µ–∫",
                "description": """üñºÔ∏è 7 NFT –≤ –¥–µ–Ω—å, 4 –≥–∏—Ñ—Ç–∞ –≤ –¥–µ–Ω—å üñºÔ∏è
                
üìÖ 210 NFT –≤ –º–µ—Å—è—Ü, 120 –≥–∏—Ñ—Ç–æ–≤ –≤ –º–µ—Å—è—Ü

üìä –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 1% –Ω–∞ –æ–¥–Ω–æ NFT, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ–º—ã—Ö NFT –≤ –¥–µ–Ω—å ‚Äì 7, —Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ 7*2% = 14% –Ω–∞ –ø–æ–±–µ–¥—É –∑–∞ –¥–µ–Ω—å, –≤ –º–µ—Å—è—Ü –ø–æ–ª—É—á–∞–µ—Ç—Å—è 420%

üéÅ –ù–∞ –≥–∏—Ñ—Ç—ã –∑–∞ –∑–≤–µ–∑–¥—ã –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 2%, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ–º—ã—Ö –≥–∏—Ñ—Ç–æ–≤ –≤ –¥–µ–Ω—å ‚Äì 4, —Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ 4*2% = 8% –Ω–∞ –ø–æ–±–µ–¥—É –∑–∞ –¥–µ–Ω—å, –≤ –º–µ—Å—è—Ü –ø–æ–ª—É—á–∞–µ—Ç—Å—è 240%

üí∞ –ù–∞ –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –¢–ì–ö –ø–æ–ª—É—á–∞–µ—Ç—Å—è –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –≤ 70% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –º–µ—Å—è—Ü (–≤ —Ä–∞–∑–º–µ—Ä–µ 4 NFT+ 2 –≥–∏—Ñ—Ç–∞ –∑–∞ 50 –∑–≤.)

üí∞ –æ–∫—É–ø –æ—Ç —Ö1 –¥–æ —Ö2,5-3""",
                "price_ton": 13
            }
        ]

        # –¢–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π
        self.WELCOME_MESSAGE = """üéâ welcome to the PassiveNFT üéâ

üí∞ PassiveNFT —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ü–†–ò–£–ú–ù–û–ñ–ò–¢–¨ —Å–≤–æ–∏ –≤–ª–æ–∂–µ–Ω–∏—è –≤–ø–ª–æ—Ç—å –¥–æ —Ö10! üí∞

üìã –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é –ø–æ–¥–ø–∏—Å–æ–∫ –∏ —á—Ç–æ –≤ –Ω–∏—Ö –≤—Ö–æ–¥–∏—Ç –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–µ "–ü–æ–¥–ø–∏—Å–∫–∏".

‚ùì –µ—Å–ª–∏ —É –≤–∞—Å –≤—Å—ë –µ—â–µ –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–≤—è–∑—å" –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É –ø–æ –≤–æ–ø—Ä–æ—Å–ª–∞–º."""

        self.SUBSCRIPTION_DESCRIPTION = "üí≥ –ù–∞–∂–º–∏ –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é —Ç–µ–±—è –ø–æ–¥–ø–∏—Å–∫—É"
        self.CONTACT_MESSAGE = "üí¨ –ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –∫–∞–∫–∏–µ-–ª–∏–±–æ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å –æ–ø–ª–∞—Ç–æ–π –∏–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É \"–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å\"."
        self.REFERRAL_MESSAGE = "üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –∞–º–±–∞—Å—Å–∞–¥–æ—Ä–æ–≤ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ PassiveNFT –∏ –æ–±—ã—á–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n\nüîó –û–Ω–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏, –≥–¥–µ –≤–ª–∞–¥–µ–ª–µ—Ü —Å—Å—ã–ª–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è 10% —Å –µ–≥–æ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏, –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å\"."

        self.ACTIVITY_SUBSCRIPTION_TYPE_MESSAGE = """–ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏, –≤—ã–±–µ—Ä–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏:"""

        self.ACTIVITY_SUBSCRIPTION_DESCRIPTION = """–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π –º–µ–Ω–µ–µ –∑–∞—Ç—Ä–∞—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏—É–º–Ω–æ–∂–∏—Ç—å —Å–≤–æ–∏ –≤–ª–æ–∂–µ–Ω–∏—è –ø—É—Ç–µ–º —É—á–∞—Å—Ç–∏—è –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö

—á—Ç–æ–±—ã –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å —Ç–µ–º —á—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –ø–æ–¥–ø–∏—Å–∫—É, –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–≤—à–∏–π –≤–∞—Å –≤–∞—Ä–∏–∞–Ω—Ç —Å–Ω–∏–∑—É"""
        
        self.REFERRAL_WELCOME_MESSAGE = """üéâ welcome to the PassiveNFT üéâ

üí∞ PassiveNFT —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ü–†–ò–£–ú–ù–û–ñ–ò–¢–¨ —Å–≤–æ–∏ –≤–ª–æ–∂–µ–Ω–∏—è –≤–ø–ª–æ—Ç—å –¥–æ —Ö10! üí∞

üîó –í—ã –ø—Ä–∏—à–ª–∏ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ!

üìã –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é –ø–æ–¥–ø–∏—Å–æ–∫ –∏ —á—Ç–æ –≤ –Ω–∏—Ö –≤—Ö–æ–¥–∏—Ç –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–µ "–ü–æ–¥–ø–∏—Å–∫–∏"

‚ùì –µ—Å–ª–∏ —É –≤–∞—Å –≤—Å—ë –µ—â–µ –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–≤—è–∑—å" –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É –ø–æ –≤–æ–ø—Ä–æ—Å–ª–∞–º."""

        self.REFERRAL_LINK_MESSAGE = "üîó **–í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:**\n\n–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ 10% —Å –∫–∞–∂–¥–æ–π –∏—Ö –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏!"
        
        self.REFERRAL_STATS_MESSAGE = """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∞—à–∏—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:
{referrals_info}"""

        self.STARS_PAYMENT_MESSAGE_TEMPLATE = f"""–¥–ª—è –æ–ø–ª–∞—Ç—ã –ø–æ TON –∫–æ—à–µ–ª—å–∫—É –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ [{self.TON_WALLET_ADDRESS}](ton://transfer?amount={{ton_amount}}&address={self.TON_WALLET_ADDRESS}) –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ {{ton_amount}} TON (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ ~{{stars}} –∑–≤–µ–∑–¥–∞–º).
–¥–ª—è –æ–ø–ª–∞—Ç—ã –ó–í–ï–ó–î–û–ß–ö–ê–ú–ò –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–µ "–û–ø–ª–∞—Ç–∏—Ç—å –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏" –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–¥–∞—Ä–∫–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ + –æ–ø–ª–∞—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏
–ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."""

        self.STAR_SUBSCRIPTION_PLANS = [
            {
                "stars": 25,
                "ton_price": 0.2,
                "lot_cost": 15,
                "description": """–∑–∞ –≤—Ö–æ–¥ –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ 25 –ó–í–ï–ó–î–û–ß–ï–ö –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —à–∞–Ω—Å –ø—Ä–∏—É–º–Ω–æ–∂–∏—Ç—å —Å–≤–æ—é –≤–ª–æ–∂–µ–Ω–∏—è –≤–ø–ª–æ—Ç—å –¥–æ —Ö56, –≤—Å—ë –∑–∞–≤–∏—Å–∏—Ç –ª–∏—à—å –æ—Ç –≤–∞—à–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —É–¥–∞—á–∏.

—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–æ–∑—ã–≥—Ä—ã–≤–∞–µ–º–æ–≥–æ –ª–æ—Ç–∞ –≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö 15 –∑–≤–µ–∑–¥–æ—á–µ–∫, –≤ –¥–µ–Ω—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç 13 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∫–æ—Ç–æ—Ä—ã–µ –∏–¥—É—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ —Ç–µ—á–µ–Ω–∏–∏ 7 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–ø—É—Å–∫–∞ –¢–ì–ö.

–≤ –ø–æ–¥–ø–∏—Å–∫—É –≤—Ö–æ–¥—è—Ç:

‚úÖ –¥–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –¢–ì–ö –Ω–∞ –ù–ï–î–ï–õ–Æ, –≥–¥–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
‚úÖ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ö–ê–ñ–î–´–ô —á–∞—Å —Å 9:00 –¥–æ 21:00 –ø–æ –ú–°–ö
‚úÖ 13 –∞–∫—Ç–∏–≤–Ω–æ—Ç–µ–π –≤ –î–ï–ù–¨
‚úÖ 91 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –≤ –ù–ï–î–ï–õ–Æ –Ω–∞ —Å—É–º–º—É ~1400 –∑–≤–µ–∑–¥–æ—á–µ–∫

–≤—ã–¥–∞—á–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ —Ç–µ—á–µ–Ω–∏–∏ 5-7 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."""
            },
            {
                "stars": 50,
                "ton_price": 0.4,
                "lot_cost": 25,
                "description": """–∑–∞ –≤—Ö–æ–¥ –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ 50 –ó–í–ï–ó–î–û–ß–ï–ö –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —à–∞–Ω—Å –ø—Ä–∏—É–º–Ω–æ–∂–∏—Ç—å —Å–≤–æ—é –≤–ª–æ–∂–µ–Ω–∏—è –≤–ø–ª–æ—Ç—å –¥–æ —Ö46, –≤—Å—ë –∑–∞–≤–∏—Å–∏—Ç –ª–∏—à—å –æ—Ç –≤–∞—à–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —É–¥–∞—á–∏.

—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–æ–∑—ã–≥—Ä—ã–≤–∞–µ–º–æ–≥–æ –ª–æ—Ç–∞ –≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö 25 –∑–≤–µ–∑–¥–æ—á–µ–∫, –≤ –¥–µ–Ω—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç 13 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∫–æ—Ç–æ—Ä—ã–µ –∏–¥—É—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ —Ç–µ—á–µ–Ω–∏–∏ 7 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–ø—É—Å–∫–∞ –¢–ì–ö.

–≤ –ø–æ–¥–ø–∏—Å–∫—É –≤—Ö–æ–¥—è—Ç:

‚úÖ –¥–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –¢–ì–ö –Ω–∞ –ù–ï–î–ï–õ–Æ, –≥–¥–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
‚úÖ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ö–ê–ñ–î–´–ô —á–∞—Å —Å 9:00 –¥–æ 21:00 –ø–æ –ú–°–ö
‚úÖ 13 –∞–∫—Ç–∏–≤–Ω–æ—Ç–µ–π –≤ –î–ï–ù–¨
‚úÖ 91 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –≤ –ù–ï–î–ï–õ–Æ –Ω–∞ —Å—É–º–º—É ~2300 –∑–≤–µ–∑–¥–æ—á–µ–∫

–≤—ã–¥–∞—á–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ —Ç–µ—á–µ–Ω–∏–∏ 5-7 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."""
            },
            {
                "stars": 75,
                "ton_price": 0.6,
                "lot_cost": 50,
                "description": """–∑–∞ –≤—Ö–æ–¥ –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ 75 –ó–í–ï–ó–î–û–ß–ï–ö –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —à–∞–Ω—Å –ø—Ä–∏—É–º–Ω–æ–∂–∏—Ç—å —Å–≤–æ—é –≤–ª–æ–∂–µ–Ω–∏—è –≤–ø–ª–æ—Ç—å –¥–æ —Ö61, –≤—Å—ë –∑–∞–≤–∏—Å–∏—Ç –ª–∏—à—å –æ—Ç –≤–∞—à–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —É–¥–∞—á–∏.

—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–æ–∑—ã–≥—Ä—ã–≤–∞–µ–º–æ–≥–æ –ª–æ—Ç–∞ –≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö 50 –∑–≤–µ–∑–¥–æ—á–µ–∫, –≤ –¥–µ–Ω—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç 13 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∫–æ—Ç–æ—Ä—ã–µ –∏–¥—É—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ —Ç–µ—á–µ–Ω–∏–∏ 7 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–ø—É—Å–∫–∞ –¢–ì–ö.

–≤ –ø–æ–¥–ø–∏—Å–∫—É –≤—Ö–æ–¥—è—Ç:

‚úÖ –¥–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –¢–ì–ö –Ω–∞ –ù–ï–î–ï–õ–Æ, –≥–¥–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
‚úÖ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ö–ê–ñ–î–´–ô —á–∞—Å —Å 9:00 –¥–æ 21:00 –ø–æ –ú–°–ö
‚úÖ 13 –∞–∫—Ç–∏–≤–Ω–æ—Ç–µ–π –≤ –î–ï–ù–¨
‚úÖ 91 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –≤ –ù–ï–î–ï–õ–Æ –Ω–∞ —Å—É–º–º—É ~4600 –∑–≤–µ–∑–¥–æ—á–µ–∫

–≤—ã–¥–∞—á–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ —Ç–µ—á–µ–Ω–∏–∏ 5-7 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."""
            },
            {
                "stars": 100,
                "ton_price": 0.8,
                "lot_cost": 50,
                "description": """–∑–∞ –≤—Ö–æ–¥ –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ 100 –ó–í–ï–ó–î–û–ß–ï–ö –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —à–∞–Ω—Å –ø—Ä–∏—É–º–Ω–æ–∂–∏—Ç—å —Å–≤–æ—é –≤–ª–æ–∂–µ–Ω–∏—è –≤–ø–ª–æ—Ç—å –¥–æ —Ö69, –≤—Å—ë –∑–∞–≤–∏—Å–∏—Ç –ª–∏—à—å –æ—Ç –≤–∞—à–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —É–¥–∞—á–∏.

—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–æ–∑—ã–≥—Ä—ã–≤–∞–µ–º–æ–≥–æ –ª–æ—Ç–∞ –≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö 75 –∑–≤–µ–∑–¥–æ—á–µ–∫, –≤ –¥–µ–Ω—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç 13 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∫–æ—Ç–æ—Ä—ã–µ –∏–¥—É—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ —Ç–µ—á–µ–Ω–∏–∏ 7 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–ø—É—Å–∫–∞ –¢–ì–ö.

–≤ –ø–æ–¥–ø–∏—Å–∫—É –≤—Ö–æ–¥—è—Ç:

‚úÖ –¥–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –¢–ì–ö –Ω–∞ –ù–ï–î–ï–õ–Æ, –≥–¥–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
‚úÖ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ö–ê–ñ–î–´–ô —á–∞—Å —Å 9:00 –¥–æ 21:00 –ø–æ –ú–°–ö
‚úÖ 13 –∞–∫—Ç–∏–≤–Ω–æ—Ç–µ–π –≤ –î–ï–ù–¨
‚úÖ 91 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –≤ –ù–ï–î–ï–õ–Æ –Ω–∞ —Å—É–º–º—É ~6900 –∑–≤–µ–∑–¥–æ—á–µ–∫

–≤—ã–¥–∞—á–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ —Ç–µ—á–µ–Ω–∏–∏ 5-7 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."""
            }
        ]

        self.PAYMENT_INSTRUCTIONS = f"""–î–ª—è –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ {self.TON_WALLET_ADDRESS} –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤—ã—à–µ –∞–¥—Ä–µ—Å TON –∫–æ—à–µ–ª—å–∫–∞.
‚ö†Ô∏è –í–ê–ñ–ù–û: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É TON."""

    def _get_env_var(self, var_name: str, default_value: str = None) -> str:
        """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
        import os
        value = os.getenv(var_name, default_value)
        if not value:
            logger.warning(f"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è {var_name} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É—é –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        return value

    def get_admin_usernames(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–æ–≤ –ø–æ username"""
        return ["pro.player.egor", "admin"]

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
try:
    if os.path.exists('config_deploy_new.py'):
        from config_deploy_new import config
        logger.info("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ config_deploy_new.py")
    elif os.path.exists('config_deploy.py'):
        from config_deploy import config
        logger.info("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ config_deploy.py")
    else:
        config = SafeConfig()
        logger.info("‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
        logger.info(f"ü§ñ –ë–æ—Ç: @{config.BOT_USERNAME}")
        logger.info(f"üí∞ –ö–æ—à–µ–ª–µ–∫: {config.TON_WALLET_ADDRESS[:10]}...{config.TON_WALLET_ADDRESS[-10:]}")
except Exception as e:
    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
    try:
        config = SafeConfig()
        logger.info("‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
        logger.info(f"ü§ñ –ë–æ—Ç: @{config.BOT_USERNAME}")
        logger.info(f"üí∞ –ö–æ—à–µ–ª–µ–∫: {config.TON_WALLET_ADDRESS[:10]}...{config.TON_WALLET_ADDRESS[-10:]}")
    except Exception as e2:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e2}")
        raise

print("üöÄ PassiveNFT Bot ULTIMATE VERSION —Å –ø–æ–ª–Ω—ã–º–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –∑–∞–≥—Ä—É–∂–µ–Ω!")
print("‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã")
print("‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
print("‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é")

# ==============================================================================
# –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° –ë–û–¢–ê
# ==============================================================================

class PassiveNFTBot:
    """–ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –±–æ—Ç–∞ —Å –ø–æ–ª–Ω—ã–º–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏"""
    
    def __init__(self):
        self.config = config
        self.database = AsyncDatabaseManager()
        self.application = None
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        self.user_cache = UserCache()
        
        # –î–û–ë–ê–í–õ–ï–ù–û: –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–∂–∏–¥–∞—é—â–∏—Ö –≤–≤–æ–¥ username –¥–ª—è /confirmpay
        self.confirmpay_pending_users = {}  # {user_id: subscription_type}
        
        # –î–û–ë–ê–í–õ–ï–ù–û: –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        self.confirmation_history = []  # –°–ø–∏—Å–æ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π [{username, subscription_type, admin_id, timestamp}]
        self.start_time = datetime.now()
        
        logger.info("üöÄ PassiveNFT Bot ULTIMATE VERSION –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        self.setup_telegram_application()

    def setup_telegram_application(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"""
        try:
            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π
            self.application = (
                Application.builder()
                .token(self.config.BOT_TOKEN)
                .concurrent_updates(True)  # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                .build()
            )

            # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            handlers = [
                CommandHandler("start", self.start_command),
                CommandHandler("confirm_payment", self.confirm_payment_command),
                CommandHandler("confirmpay", self.confirmpay_command),
                CommandHandler("adminserveraa", self.admin_command),
                CommandHandler("adminserveraastat", self.admin_stats_command),
                CommandHandler("adminserveraapeople", self.admin_people_command),
                CommandHandler("adminserveraaref", self.admin_referrals_command),
                CommandHandler("broadcast", self.broadcast_command),
                CommandHandler("channel_info", self.channel_info_command),
                CommandHandler("get_channel_id", self.get_channel_id_command),
                CommandHandler("testcmd", self.testcmd_command),
                
                # Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                CallbackQueryHandler(self.subscription_callback, pattern="^subscription$"),
                CallbackQueryHandler(self.select_stars_callback, pattern="^select_stars$"),
                CallbackQueryHandler(self.select_ton_callback, pattern="^select_ton$"),
                CallbackQueryHandler(self.subscription_plan_callback, pattern="^subscription_plan_"),
                CallbackQueryHandler(self.ton_subscription_plan_callback, pattern="^ton_subscription_plan_"),
                CallbackQueryHandler(self.payment_callback, pattern="^payment_"),
                CallbackQueryHandler(self.activity_subscription_callback, pattern="^activity_subscription_"),
                CallbackQueryHandler(self.star_subscription_plan_callback, pattern="^star_plan_"),
                CallbackQueryHandler(self.stars_payment_callback, pattern="^stars_payment_"),
                CallbackQueryHandler(self.copy_stars_ton_callback, pattern="^copy_stars_ton_"),
                CallbackQueryHandler(self.stars_payment_stars_callback, pattern="^stars_payment_stars_"),
                CallbackQueryHandler(self.confirmpay_subscription_type_callback, pattern="^confirmpay_type_"),
                CallbackQueryHandler(self.confirmpay_confirm_callback, pattern="^confirmpay_confirm_"),
                CallbackQueryHandler(self.confirmpay_history_callback, pattern="^confirmpay_history$"),
                CallbackQueryHandler(self.confirmpay_stats_callback, pattern="^confirmpay_stats$"),
                CallbackQueryHandler(self.confirmpay_back_callback, pattern="^confirmpay_back$"),
                CallbackQueryHandler(self.contact_callback, pattern="^contact$"),
                CallbackQueryHandler(self.referral_callback, pattern="^referral$"),
                CallbackQueryHandler(self.get_referral_link_callback, pattern="^get_referral$"),
                CallbackQueryHandler(self.referral_stats_callback, pattern="^referral_stats$"),
                CallbackQueryHandler(self.copy_ton_callback, pattern="^copy_ton_"),
                CallbackQueryHandler(self.back_callback, pattern="^back$"),
                
                # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message)
            ]
            
            for handler in handlers:
                self.application.add_handler(handler)

            logger.info("‚úÖ Telegram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: {e}")
            raise

    # ==============================================================================
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: –ë–ï–ó–û–ü–ê–°–ù–´–ï –û–ü–ï–†–ê–¶–ò–ò –° –¢–ê–ô–ú–ê–£–¢–ê–ú–ò
    # ==============================================================================

    async def safe_get_user(self, update: Update) -> Optional[dict]:
        """–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—à–∏–±–æ–∫"""
        try:
            user = update.effective_user
            if not user:
                logger.warning("‚ö†Ô∏è effective_user is None")
                return None
                
            return {
                'id': getattr(user, 'id', 0),
                'username': getattr(user, 'username', '') or '',
                'first_name': getattr(user, 'first_name', '') or '',
                'last_name': getattr(user, 'last_name', '') or ''
            }
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            return None

    async def safe_database_operation(self, operation_name: str, operation_func, timeout: float = 5.0):
        """–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —Å —Ç–∞–π–º–∞—É—Ç–æ–º"""
        try:
            logger.info(f"üîÑ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ {operation_name}...")
            
            # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            task = asyncio.create_task(operation_func())
            result = await asyncio.wait_for(task, timeout=timeout)
            
            logger.info(f"‚úÖ {operation_name} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ")
            return result
            
        except asyncio.TimeoutError:
            logger.error(f"‚è∞ –¢–∞–π–º–∞—É—Ç {operation_name} ({timeout}s)")
            return None
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ {operation_name}: {e}")
            return None

    # ==============================================================================
    # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #2: –§–û–ù–û–í–´–ï –ó–ê–î–ê–ß–ò
    # ==============================================================================
    
    async def background_add_user(self, user_data: dict, referrer_id: Optional[int] = None):
        """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            async with asyncio.timeout(5.0):  # –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥
                # –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                await self.database.get_or_create_user(
                    user_data['id'],
                    user_data['username'],
                    user_data['first_name'],
                    user_data['last_name']
                )
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
                if referrer_id and referrer_id != user_data['id']:
                    await self.database.save_pending_referral(user_data['id'], referrer_id)
                
                # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                self.user_cache.invalidate(user_data['id'])
                logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_data['id']} –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ñ–æ–Ω")
                
        except asyncio.TimeoutError:
            logger.warning(f"‚è∞ –¢–∞–π–º–∞—É—Ç —Ñ–æ–Ω–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_data['id']}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_data['id']}: {e}")

    # ==============================================================================
    # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –û–ß–ò–°–¢–ö–ê WEBHOOK
    # ==============================================================================
    async def clear_webhook_on_startup(self):
        """–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—Å—Ç–∫–∞ webhook –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º"""
        try:
            logger.info("üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–Ω—ã—Ö webhook'–æ–≤...")
            # –û—á–∏—Å—Ç–∫–∞ webhook —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            await asyncio.wait_for(
                self.application.bot.delete_webhook(drop_pending_updates=True),
                timeout=15.0
            )
            logger.info("‚úÖ Webhook –æ—á–∏—â–µ–Ω —É—Å–ø–µ—à–Ω–æ")
            await asyncio.sleep(2)
        except asyncio.TimeoutError:
            logger.warning("‚è∞ Timeout –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ webhook - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫")
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ webhook: {e} - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫")

    # ==============================================================================
    # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #6: –ó–ê–ü–£–°–ö POLLING –° –ü–†–ê–í–ò–õ–¨–ù–û–ô –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ï–ô
    # ==============================================================================
    
    async def start_polling_with_retry(self, max_retries=3):
        """–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫ polling —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π ExtBot"""
        for attempt in range(1, max_retries + 1):
            try:
                logger.info(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt}/{max_retries} - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...")
                
                # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞
                await asyncio.wait_for(
                    self.application.initialize(),
                    timeout=30.0
                )
                
                logger.info(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt}/{max_retries} - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...")
                
                # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –±–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
                if hasattr(self.application, '_initialized') and not self.application._initialized:
                    logger.info("üîÑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞...")
                    await asyncio.sleep(2)
                
                logger.info(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt}/{max_retries} - –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...")
                
                # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                await asyncio.wait_for(
                    self.application.start(),
                    timeout=10.0
                )
                
                logger.info(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt}/{max_retries} - –ó–∞–ø—É—Å–∫ polling...")
                
                # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫ polling —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                await asyncio.wait_for(
                    self.application.updater.start_polling(
                        poll_interval=0.05,
                        timeout=10,
                        drop_pending_updates=True,
                        bootstrap_retries=3
                    ),
                    timeout=15.0
                )
                
                logger.info(f"‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω —Å –ø–æ–ø—ã—Ç–∫–∏ {attempt}")
                logger.info("üì° Polling –Ω–∞—á–∞—Ç - –±–æ—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏–π")
                logger.info("‚ö° –û–ñ–ò–î–ê–ï–ú–û–ï –í–†–ï–ú–Ø –û–¢–í–ï–¢–ê –ù–ê /START: 0.1-0.5 –°–ï–ö–£–ù–î–´")
                logger.info("üöÄ CALLBACK –ö–ù–û–ü–ö–ò –û–¢–í–ï–ß–ê–Æ–¢ –ú–ì–ù–û–í–ï–ù–ù–û")
                return True
                
            except (asyncio.TimeoutError, TelegramError, httpx.ConnectTimeout) as e:
                logger.error(f"‚è∞ –ü–æ–ø—ã—Ç–∫–∞ {attempt}/{max_retries} - –û—à–∏–±–∫–∞: {e}")
                
                if attempt < max_retries:
                    wait_time = 5 * attempt
                    logger.info(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ {wait_time} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
                    await asyncio.sleep(wait_time)
                else:
                    logger.error(f"‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
                    raise
                    
            except Exception as e:
                logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –ø–æ–ø—ã—Ç–∫–µ {attempt}: {e}")
                if attempt == max_retries:
                    raise
                await asyncio.sleep(5)

    # ==============================================================================
    # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #7: –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –û–°–¢–ê–ù–û–í–ö–ê
    # ==============================================================================
    
    async def safe_shutdown(self):
        """–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞"""
        logger.info("üõë –ù–∞—á–∏–Ω–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É –±–æ—Ç–∞...")
        try:
            if self.application and hasattr(self.application, 'updater') and self.application.updater.running:
                self.application.updater.stop()
                logger.info("‚úÖ Polling –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                
            if self.application and self.application.running:
                await self.application.stop()
                await self.application.shutdown()
                logger.info("‚úÖ –ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞: {e}")

    # ==============================================================================
    # –ì–õ–ê–í–ù–´–ô –ú–ï–¢–û–î –ó–ê–ü–£–°–ö–ê
    # ==============================================================================
    
    async def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å –ø–æ–ª–Ω—ã–º–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏"""
        logger.info("üöÄ –ó–∞–ø—É—Å–∫ PassiveNFT Bot ULTIMATE VERSION...")
        
        try:
            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            logger.info("üóÑÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
            await self.safe_database_operation(
                "–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î",
                lambda: self.database.initialize(),
                timeout=10.0
            )
            logger.info("‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
            
            logger.info(f"ü§ñ –ë–æ—Ç: @{self.config.BOT_USERNAME}")
            logger.info(f"üí∞ –ö–æ—à–µ–ª–µ–∫: {self.config.TON_WALLET_ADDRESS[:10]}...{self.config.TON_WALLET_ADDRESS[-10:]}")
            logger.info("‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –≤–∫–ª—é—á–µ–Ω—ã")
            logger.info("üîß –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –ê–ö–¢–ò–í–ù–´")
            logger.info("‚ö° –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò –ê–ö–¢–ò–í–ù–´")

            # –û—á–∏—Å—Ç–∫–∞ webhook –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            await self.clear_webhook_on_startup()

            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫ polling —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
            await self.start_polling_with_retry()
            
            logger.info("üéØ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
            logger.info("üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò –ê–ö–¢–ò–í–ù–´:")
            logger.info("‚ö° /start –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ 0.1-0.5 —Å–µ–∫—É–Ω–¥—ã (–≤–º–µ—Å—Ç–æ 30-60 —Å–µ–∫—É–Ω–¥)")
            logger.info("üöÄ –í—Å–µ callback –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—á–∞—é—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ")
            logger.info("üíæ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç")
            logger.info("üõ°Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞—â–∏—Ç–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è")
            
            # –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
            while True:
                try:
                    await asyncio.Event().wait()
                except asyncio.CancelledError:
                    logger.info("‚èπÔ∏è –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ polling")
                    break
                    
        except Exception as e:
            logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ run: {e}")
            logger.error(f"Traceback: {traceback.format_exc()}")
            raise
        finally:
            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
            await self.safe_shutdown()

    # ==============================================================================
    # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #5: –ú–ì–ù–û–í–ï–ù–ù–´–ô –û–¢–í–ï–¢ –ù–ê /START
    # ==============================================================================
    
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ /start –±–µ–∑ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π"""
        logger.info(f"–ö–û–ú–ê–ù–î–ê –ü–û–õ–£–ß–ï–ù–ê: /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
        try:
            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_data = await self.safe_get_user(update)
            if not user_data:
                await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
                return
                
            logger.info(f"üìù –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ID={user_data['id']}, Username={user_data['username']}")
            
            args = context.args
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –°–†–ê–ó–£
            referrer_id = None
            if args and len(args) > 0:
                arg = args[0]
                if arg.startswith('ref_'):
                    try:
                        referrer_id = int(arg[4:])  # –£–±–∏—Ä–∞–µ–º "ref_" –∏ –ø–æ–ª—É—á–∞–µ–º ID
                        if referrer_id != user_data['id']:  # –ù–µ–ª—å–∑—è –±—ã—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–º —Å–∞–º–æ–º—É —Å–µ–±–µ
                            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_data['id']} –ø—Ä–∏—à–µ–ª –æ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ {referrer_id}")
                    except ValueError:
                        pass  # –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º

            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú–ì–ù–û–í–ï–ù–ù–´–ô –û–¢–í–ï–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ
            if referrer_id:
                welcome_text = self.config.REFERRAL_WELCOME_MESSAGE
            else:
                welcome_text = self.config.WELCOME_MESSAGE

            # –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò
            keyboard = [
                [InlineKeyboardButton("üí≥ –ü–æ–¥–ø–∏—Å–∫–∏", callback_data="subscription")],
                [InlineKeyboardButton("üí¨ –°–≤—è–∑—å", callback_data="contact")],
                [InlineKeyboardButton("üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞", callback_data="referral")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–¢–í–ï–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ú–ì–ù–û–í–ï–ù–ù–û
            await update.message.reply_text(welcome_text, reply_markup=reply_markup)
            logger.info(f"‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ /start –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_data['id']}")
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –§–û–ù–û–í–ê–Ø –û–ü–ï–†–ê–¶–ò–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
            try:
                asyncio.create_task(self.background_add_user(user_data, referrer_id))
                logger.info(f"üåü –§–æ–Ω–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_data['id']} –∑–∞–ø—É—â–µ–Ω–æ")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ñ–æ–Ω–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ start_command: {e}")
            logger.error(f"Traceback: {traceback.format_exc()}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    # ==============================================================================
    # –ó–ê–ì–õ–£–®–ö–ò –î–õ–Ø –í–°–ï–• –û–°–¢–ê–õ–¨–ù–´–• –ú–ï–¢–û–î–û–í
    # ==============================================================================
    
    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
    # –ó–¥–µ—Å—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    
    async def subscription_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ü–æ–¥–ø–∏—Å–∫–∏'"""
        try:
            query = update.callback_query
            await query.answer()  # –ú–ì–ù–û–í–ï–ù–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ö–õ–ò–ö–ê

            subscription_text = self.config.SUBSCRIPTION_DESCRIPTION

            keyboard = [
                [InlineKeyboardButton("‚ö° –° –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º–∏ (–∑–∞ –∑–≤–µ–∑–¥–æ—á–∫–∏)", callback_data="select_stars")],
                [InlineKeyboardButton("üíé –ë–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π (–∑–∞ TON)", callback_data="select_ton")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back")]
            ]

            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(subscription_text, reply_markup=reply_markup)
            logger.info(f"‚úÖ –ü–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ subscription_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def contact_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–°–≤—è–∑—å'"""
        try:
            query = update.callback_query
            await query.answer()

            contact_text = self.config.CONTACT_MESSAGE

            keyboard = [
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back")],
                [InlineKeyboardButton("üìû –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å", url=f"https://t.me/{self.config.MANAGER_USERNAME}")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(contact_text, reply_markup=reply_markup, parse_mode='HTML')
            logger.info(f"‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ contact_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    # ==============================================================================
    # –ü–û–î–ü–ò–°–ö–ò –ò –ü–õ–ê–¢–ï–ñ–ò
    # ==============================================================================
    
    async def select_stars_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ Stars –ø–æ–¥–ø–∏—Å–æ–∫"""
        try:
            query = update.callback_query
            await query.answer()

            stars_text = "‚≠êÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç –∑–≤–µ–∑–¥–æ—á–µ–∫:"

            keyboard = [
                [InlineKeyboardButton("‚≠êÔ∏è 25 –∑–≤–µ–∑–¥", callback_data="star_plan_25")],
                [InlineKeyboardButton("‚≠êÔ∏è 50 –∑–≤–µ–∑–¥", callback_data="star_plan_50")],
                [InlineKeyboardButton("‚≠êÔ∏è 75 –∑–≤–µ–∑–¥", callback_data="star_plan_75")],
                [InlineKeyboardButton("‚≠êÔ∏è 100 –∑–≤–µ–∑–¥", callback_data="star_plan_100")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="subscription")]
            ]

            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(stars_text, reply_markup=reply_markup)
            logger.info(f"‚úÖ Stars –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ select_stars_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def select_ton_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ TON –ø–æ–¥–ø–∏—Å–æ–∫"""
        try:
            query = update.callback_query
            await query.answer()

            ton_text = "üíé –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∑–∞ TON:"

            keyboard = []
            for i, plan in enumerate(self.config.SUBSCRIPTION_PLANS):
                keyboard.append([InlineKeyboardButton(
                    f"üíé {plan['name']} ({plan['price_ton']} TON)", 
                    callback_data=f"ton_subscription_plan_{i}"
                )])
            
            keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="subscription")])
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(ton_text, reply_markup=reply_markup)
            logger.info(f"‚úÖ TON –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ select_ton_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def star_subscription_plan_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø–ª–∞–Ω–∞ Stars –ø–æ–¥–ø–∏—Å–∫–∏"""
        try:
            query = update.callback_query
            await query.answer()

            stars_count = int(query.data.split('_')[2])
            plan = next((p for p in self.config.STAR_SUBSCRIPTION_PLANS if p['stars'] == stars_count), None)
            
            if not plan:
                await query.answer("‚ùå –ü–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return

            plan_text = f"""‚≠êÔ∏è –ü–õ–ê–ù –ù–ê {plan['stars']} –ó–í–ï–ó–î–û–ß–ï–ö

{plan['description']}

üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {plan['stars']} –∑–≤–µ–∑–¥ ({plan['ton_price']} TON)"""

            keyboard = [
                [InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏", callback_data=f"stars_payment_{stars_count}")],
                [InlineKeyboardButton("üí∞ –û–ø–ª–∞—Ç–∏—Ç—å TON", callback_data=f"copy_stars_ton_{stars_count}")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="select_stars")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(plan_text, reply_markup=reply_markup)
            logger.info(f"‚úÖ –ü–ª–∞–Ω Stars {stars_count} –ø–æ–∫–∞–∑–∞–Ω")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ star_subscription_plan_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    # ==============================================================================
    # –ü–õ–ê–¢–ï–ñ–ò –ò –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
    # ==============================================================================
    
    async def stars_payment_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–ø–ª–∞—Ç—ã –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏"""
        try:
            query = update.callback_query
            await query.answer()

            stars_count = int(query.data.split('_')[2])
            plan = next((p for p in self.config.STAR_SUBSCRIPTION_PLANS if p['stars'] == stars_count), None)
            
            if not plan:
                await query.answer("‚ùå –ü–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return

            payment_text = f"""üíé –û–ü–õ–ê–¢–ê –ó–í–ï–ó–î–û–ß–ö–ê–ú–ò

‚≠êÔ∏è –°—É–º–º–∞: {plan['stars']} –∑–≤–µ–∑–¥
üí∞ –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ TON: {plan['ton_price']} TON

üì± –î–ª—è –æ–ø–ª–∞—Ç—ã –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–¥–∞—Ä–æ–∫ –Ω–∞ —Å—É–º–º—É –ø–æ–¥–ø–∏—Å–∫–∏."""

            keyboard = [
                [InlineKeyboardButton("üéÅ –û–ø–ª–∞—Ç–∏—Ç—å –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏", url=f"https://t.me/{self.config.STARS_USERNAME}")],
                [InlineKeyboardButton("üí∞ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: TON", callback_data=f"copy_stars_ton_{stars_count}")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"star_plan_{stars_count}")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(payment_text, reply_markup=reply_markup)
            logger.info(f"‚úÖ –û–ø–ª–∞—Ç–∞ Stars {stars_count} –æ—Ç–∫—Ä—ã—Ç–∞")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ stars_payment_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def copy_stars_ton_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è TON –∞–¥—Ä–µ—Å–∞ –¥–ª—è Stars –ø–ª–∞–Ω–æ–≤"""
        try:
            query = update.callback_query
            await query.answer()

            stars_count = int(query.data.split('_')[3])
            plan = next((p for p in self.config.STAR_SUBSCRIPTION_PLANS if p['stars'] == stars_count), None)
            
            if not plan:
                await query.answer("‚ùå –ü–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return

            payment_text = f"""üí∞ –û–ü–õ–ê–¢–ê TON

‚≠êÔ∏è –ü–ª–∞–Ω: {plan['stars']} –∑–≤–µ–∑–¥
üí∞ –°—É–º–º–∞: {plan['ton_price']} TON
üí≥ –ê–¥—Ä–µ—Å: {self.config.TON_WALLET_ADDRESS}

‚ö†Ô∏è –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∞–¥—Ä–µ—Å –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É TON."""

            keyboard = [
                [InlineKeyboardButton("üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å", callback_data=f"copy_ton_{plan['ton_price']}")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"star_plan_{stars_count}")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(payment_text, reply_markup=reply_markup, parse_mode='HTML')
            logger.info(f"‚úÖ TON –æ–ø–ª–∞—Ç–∞ –¥–ª—è Stars {stars_count} –æ—Ç–∫—Ä—ã—Ç–∞")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ copy_stars_ton_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def stars_payment_stars_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏"""
        try:
            query = update.callback_query
            await query.answer()
            await query.message.edit_text(
                "‚úÖ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏.",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º", url=f"https://t.me/{self.config.MANAGER_USERNAME}")]])
            )
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ stars_payment_stars_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def copy_ton_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è TON –∞–¥—Ä–µ—Å–∞"""
        try:
            query = update.callback_query
            await query.answer()
            
            amount = query.data.split('_')[2]
            
            copy_text = f"""üìã –°–ö–û–ü–ò–†–û–í–ê–ù –ê–î–†–ï–° –ö–û–®–ï–õ–¨–ö–ê

üí∞ –°—É–º–º–∞: {amount} TON
üí≥ –ê–¥—Ä–µ—Å: {self.config.TON_WALLET_ADDRESS}

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É –Ω–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å."""

            keyboard = [
                [InlineKeyboardButton("‚úÖ –û–ø–ª–∞—Ç–∏–ª", callback_data="payment_confirmed")],
                [InlineKeyboardButton("üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º", url=f"https://t.me/{self.config.MANAGER_USERNAME}")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(copy_text, reply_markup=reply_markup, parse_mode='HTML')
            logger.info(f"‚úÖ TON –∞–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –¥–ª—è {amount} TON")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ copy_ton_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    # ==============================================================================
    # –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê
    # ==============================================================================
    
    async def referral_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã"""
        try:
            query = update.callback_query
            await query.answer()  # –ú–ì–ù–û–í–ï–ù–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ö–õ–ò–ö–ê

            referral_text = self.config.REFERRAL_MESSAGE

            keyboard = [
                [InlineKeyboardButton("üîó –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É", callback_data="get_referral")],
                [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="referral_stats")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(referral_text, reply_markup=reply_markup)
            logger.info(f"‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–∫—Ä—ã—Ç–∞")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ referral_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def get_referral_link_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏"""
        try:
            query = update.callback_query
            await query.answer()

            user = update.effective_user
            if not user:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
                return

            # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            user_data = await self.safe_database_operation(
                "–ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                lambda: self.database.get_or_create_user(
                    user.id, 
                    user.username or "", 
                    user.first_name or "", 
                    user.last_name or ""
                )
            )

            if not user_data:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö")
                return

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
            bot_username = self.config.BOT_USERNAME
            referral_link = f"https://t.me/{bot_username}?start=ref_{user.id}"
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
            await self.safe_database_operation(
                "—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏",
                lambda: self.database.save_referral_link(user.id, referral_link)
            )

            referral_message = f"""üîó **–í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:**

{referral_link}

üì¢ –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ 10% —Å –∫–∞–∂–¥–æ–π –∏—Ö –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏!"""

            keyboard = [
                [InlineKeyboardButton("üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", callback_data="copy_referral_link")],
                [InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="referral_stats")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="referral")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(referral_message, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ get_referral_link_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def referral_stats_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤"""
        try:
            query = update.callback_query
            await query.answer()

            user = update.effective_user
            if not user:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
                return

            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
            stats_data = await self.safe_database_operation(
                "–ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤",
                lambda: self.database.get_user_referral_stats(user.id)
            )

            if stats_data:
                total_referrals = stats_data.get('total_referrals', 0)
                total_earnings = stats_data.get('total_earnings', 0.0)
                active_referrals = stats_data.get('active_referrals', 0)

                stats_text = f"""üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∞—à–∏—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:**

üë• –í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ: {total_referrals}
‚≠êÔ∏è –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: {active_referrals}
üí∞ –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: {total_earnings:.2f} TON

üí° –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞!"""
            else:
                stats_text = """üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∞—à–∏—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:**

üë• –í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ: 0
‚≠êÔ∏è –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: 0
üí∞ –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: 0.00 TON

üí° –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –¥—Ä—É–≥–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å!"""

            keyboard = [
                [InlineKeyboardButton("üîó –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É", callback_data="get_referral")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="referral")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(stats_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ–∫–∞–∑–∞–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ referral_stats_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    # ==============================================================================
    # –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–ü–õ–ê–¢ (/confirmpay)
    # ==============================================================================
    
    async def confirmpay_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /confirmpay –¥–ª—è –∞–¥–º–∏–Ω–æ–≤"""
        try:
            user = update.effective_user
            logger.info(f"–ö–û–ú–ê–ù–î–ê –ü–û–õ–£–ß–ï–ù–ê: /confirmpay –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
                return

            confirmpay_text = """üí≥ **–°–ò–°–¢–ï–ú–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –û–ü–õ–ê–¢**

–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã:"""

            keyboard = [
                [InlineKeyboardButton("‚≠êÔ∏è 25 –∑–≤–µ–∑–¥", callback_data="confirmpay_type_25_stars")],
                [InlineKeyboardButton("‚≠êÔ∏è 50 –∑–≤–µ–∑–¥", callback_data="confirmpay_type_50_stars")],
                [InlineKeyboardButton("‚≠êÔ∏è 75 –∑–≤–µ–∑–¥", callback_data="confirmpay_type_75_stars")],
                [InlineKeyboardButton("‚≠êÔ∏è 100 –∑–≤–µ–∑–¥", callback_data="confirmpay_type_100_stars")],
                [InlineKeyboardButton("üíé 150 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data="confirmpay_type_150_ton")],
                [InlineKeyboardButton("üíé 100 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data="confirmpay_type_100_ton")],
                [InlineKeyboardButton("üíé 50 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data="confirmpay_type_50_ton")],
                [InlineKeyboardButton("üìä –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π", callback_data="confirmpay_history")],
                [InlineKeyboardButton("üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="confirmpay_stats")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await update.message.reply_text(confirmpay_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –ú–µ–Ω—é /confirmpay –æ—Ç–∫—Ä—ã—Ç–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {user.id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ confirmpay_command: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def confirmpay_subscription_type_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è /confirmpay"""
        try:
            query = update.callback_query
            await query.answer()

            subscription_type = query.data.replace('confirmpay_type_', '')
            user = update.effective_user
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            self.confirmpay_pending_users[user.id] = subscription_type
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
            type_names = {
                '25_stars': '25 –∑–≤–µ–∑–¥',
                '50_stars': '50 –∑–≤–µ–∑–¥',
                '75_stars': '75 –∑–≤–µ–∑–¥',
                '100_stars': '100 –∑–≤–µ–∑–¥',
                '150_ton': '150 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (TON)',
                '100_ton': '100 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (TON)',
                '50_ton': '50 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (TON)'
            }
            
            display_name = type_names.get(subscription_type, subscription_type)

            type_text = f"""üí≥ **–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–ü–õ–ê–¢–´**

–¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏: **{display_name}**

üë§ –í–≤–µ–¥–∏—Ç–µ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ —Å–∏–º–≤–æ–ª–∞ @):"""

            await query.message.edit_text(type_text, parse_mode='Markdown')
            await query.message.reply_text(
                "üìù **–û—Ç–ø—Ä–∞–≤—å—Ç–µ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã**",
                parse_mode='Markdown'
            )
            logger.info(f"‚úÖ –í—ã–±—Ä–∞–Ω —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ {subscription_type} –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ confirmpay_subscription_type_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def confirmpay_confirm_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã"""
        try:
            query = update.callback_query
            await query.answer()

            # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
            parts = query.data.split('_')
            username = parts[3]
            subscription_type = '_'.join(parts[4:])

            user = update.effective_user
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
                return

            # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ–∂–∏–¥–∞—é—â–∏—Ö
            if user.id in self.confirmpay_pending_users:
                del self.confirmpay_pending_users[user.id]

            # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
            invite_link = await self.get_invite_link_for_subscription(subscription_type)
            
            if not invite_link:
                await query.message.edit_text(
                    f"‚ùå –û–®–ò–ë–ö–ê\n\n"
                    f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è —Ç–∏–ø–∞: {subscription_type}\n"
                    f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
                )
                return

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
            confirmation_text = f"""‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–ü–õ–ê–¢–´ –í–´–ü–û–õ–ù–ï–ù–û

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: {user.username or user.first_name}
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username}
–¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏: {subscription_type}
–í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

–°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
{invite_link}

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç: –ê–∫—Ç–∏–≤–Ω–∞ ‚úÖ"""

            await query.message.edit_text(confirmation_text)
            
            # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            try:
                clean_username = username.replace('@', '')
                chat = await self.application.bot.get_chat(clean_username)
                
                user_message = f"""‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–ü–õ–ê–¢–´

–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ {subscription_type} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.

üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª:
{invite_link}

–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –ø–æ–¥–ø–∏—Å–∫—É!"""
                
                await self.application.bot.send_message(
                    chat_id=chat.id,
                    text=user_message
                )
                
                logger.info(f"‚úÖ –°–°–´–õ–ö–ê –£–°–ü–ï–®–ù–û –û–¢–ü–†–ê–í–õ–ï–ù–ê –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é @{clean_username}")
                
            except TelegramError as telegram_error:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é @{username}: {telegram_error}")
                await query.message.reply_text(
                    f"‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é @{username}\n\n"
                    f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é: {invite_link}"
                )

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ confirmpay_confirm_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def confirmpay_history_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∫–∞–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π"""
        try:
            query = update.callback_query
            await query.answer()

            if not self.confirmation_history:
                history_text = """üìä **–ò–°–¢–û–†–ò–Ø –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ô**

–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –æ–ø–ª–∞—Ç."""
            else:
                recent_confirmations = self.confirmation_history[-10:]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10
                history_text = "üìä **–ò–°–¢–û–†–ò–Ø –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ô**\n\n"
                
                for i, confirmation in enumerate(recent_confirmations, 1):
                    history_text += f"{i}. @{confirmation['username']} - {confirmation['subscription_type']}\n"
                    history_text += f"   {confirmation['timestamp'].strftime('%H:%M:%S')}\n\n"

            keyboard = [
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="confirmpay_back")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(history_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –ø–æ–∫–∞–∑–∞–Ω–∞")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ confirmpay_history_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def confirmpay_stats_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        try:
            query = update.callback_query
            await query.answer()

            if not self.confirmation_history:
                stats_text = """üìà **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ô**

–í—Å–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: 0"""
            else:
                total_confirmations = len(self.confirmation_history)
                stats_text = f"""üìà **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ô**

–í—Å–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: {total_confirmations}
–ó–∞ —Å–µ–≥–æ–¥–Ω—è: {len([c for c in self.confirmation_history if c['timestamp'].date() == datetime.now().date()])}

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ! ‚úÖ"""

            keyboard = [
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="confirmpay_back")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(stats_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –ø–æ–∫–∞–∑–∞–Ω–∞")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ confirmpay_stats_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def confirmpay_back_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é /confirmpay"""
        try:
            query = update.callback_query
            await query.answer()

            confirmpay_text = """üí≥ **–°–ò–°–¢–ï–ú–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –û–ü–õ–ê–¢**

–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã:"""

            keyboard = [
                [InlineKeyboardButton("‚≠êÔ∏è 25 –∑–≤–µ–∑–¥", callback_data="confirmpay_type_25_stars")],
                [InlineKeyboardButton("‚≠êÔ∏è 50 –∑–≤–µ–∑–¥", callback_data="confirmpay_type_50_stars")],
                [InlineKeyboardButton("‚≠êÔ∏è 75 –∑–≤–µ–∑–¥", callback_data="confirmpay_type_75_stars")],
                [InlineKeyboardButton("‚≠êÔ∏è 100 –∑–≤–µ–∑–¥", callback_data="confirmpay_type_100_stars")],
                [InlineKeyboardButton("üíé 150 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data="confirmpay_type_150_ton")],
                [InlineKeyboardButton("üíé 100 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data="confirmpay_type_100_ton")],
                [InlineKeyboardButton("üíé 50 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data="confirmpay_type_50_ton")],
                [InlineKeyboardButton("üìä –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π", callback_data="confirmpay_history")],
                [InlineKeyboardButton("üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="confirmpay_stats")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(confirmpay_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é /confirmpay")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ confirmpay_back_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    # ==============================================================================
    # –ê–î–ú–ò–ù –ö–û–ú–ê–ù–î–´
    # ==============================================================================
    
    async def admin_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–ª–∞–≤–Ω–æ–π –∞–¥–º–∏–Ω—Å–∫–æ–π –∫–æ–º–∞–Ω–¥—ã"""
        try:
            user = update.effective_user
            logger.info(f"–ö–û–ú–ê–ù–î–ê –ü–û–õ–£–ß–ï–ù–ê: /adminserveraa –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
                return

            admin_text = """üõ†Ô∏è **–ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨**

–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é –∫–æ–º–∞–Ω–¥—É:"""

            keyboard = [
                [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="adminserveraastat")],
                [InlineKeyboardButton("üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data="adminserveraapeople")],
                [InlineKeyboardButton("üîó –†–µ—Ñ–µ—Ä–∞–ª—ã", callback_data="adminserveraaref")],
                [InlineKeyboardButton("üì¢ –†–∞—Å—Å—ã–ª–∫–∞", callback_data="broadcast")],
                [InlineKeyboardButton("üîç –ö–∞–Ω–∞–ª—ã", callback_data="channel_info")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await update.message.reply_text(admin_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã—Ç–∞ –¥–ª—è {user.id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ admin_command: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def admin_stats_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        try:
            query = update.callback_query
            await query.answer()

            user = update.effective_user
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
                return

            # –ü–æ–ª—É—á–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            total_users = await self.safe_database_operation(
                "–ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
                lambda: self.database.get_total_users_count()
            )

            stats_text = f"""üìä **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–û–¢–ê**

üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users or 0}
ü§ñ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω: ‚úÖ
üïê –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: {datetime.now().strftime('%H:%M:%S')}
üìÖ –î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y')}

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ! ‚úÖ"""

            keyboard = [
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="adminserveraa")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(stats_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {user.id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ admin_stats_command: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def admin_people_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        try:
            query = update.callback_query
            await query.answer()

            user = update.effective_user
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
                return

            people_text = """üë• **–£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò**

–§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

üí° –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ direct database queries."""

            keyboard = [
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="adminserveraa")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(people_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑–∞–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {user.id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ admin_people_command: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def admin_referrals_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤"""
        try:
            query = update.callback_query
            await query.answer()

            user = update.effective_user
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
                return

            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
            total_referrals = await self.safe_database_operation(
                "–ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤",
                lambda: self.database.get_total_referrals_count()
            )

            referrals_text = f"""üîó **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ï–§–ï–†–ê–õ–û–í**

üë• –í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: {total_referrals or 0}
üí∞ –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–∏—Å—Å–∏–π: 10%
üéØ –ê–∫—Ç–∏–≤–Ω–∞: ‚úÖ

–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ! ‚úÖ"""

            keyboard = [
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="adminserveraa")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(referrals_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ–∫–∞–∑–∞–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {user.id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ admin_referrals_command: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def broadcast_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã —Ä–∞—Å—Å—ã–ª–∫–∏"""
        try:
            query = update.callback_query
            await query.answer()

            user = update.effective_user
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
                return

            broadcast_text = """üì¢ **–°–ò–°–¢–ï–ú–ê –†–ê–°–°–´–õ–ö–ò**

‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

üí° –î–ª—è –º–∞—Å—Å–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã."""

            keyboard = [
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="adminserveraa")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(broadcast_text, reply_markup=reply_markup, parse_mode='Markdown')
            logger.info(f"‚úÖ –ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏ –ø–æ–∫–∞–∑–∞–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {user.id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ broadcast_command: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    # ==============================================================================
    # –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´
    # ==============================================================================
    
    async def get_invite_link_for_subscription(self, subscription_type: str) -> Optional[str]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ –¥–ª—è —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏"""
        try:
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –∫–ª—é—á –¥–ª—è PRIVATE_CHANNEL_LINKS
            link_key = subscription_type.lower().replace('_', '_')
            
            if link_key in self.config.PRIVATE_CHANNEL_LINKS:
                return self.config.PRIVATE_CHANNEL_LINKS[link_key]
            else:
                logger.warning(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è —Ç–∏–ø–∞: {subscription_type}")
                return None
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è {subscription_type}: {e}")
            return None

    async def background_user_stats_update(self, user_id: int, stats_data: dict):
        """–§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            async with asyncio.timeout(5.0):
                await self.safe_database_operation(
                    f"–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}",
                    lambda: self.database.update_user_stats(user_id, stats_data)
                )
                logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
        except asyncio.TimeoutError:
            logger.warning(f"‚è∞ –¢–∞–π–º–∞—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")

    # ==============================================================================
    # –û–ë–†–ê–ë–û–¢–ß–ò–ö –¢–ï–ö–°–¢–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô
    # ==============================================================================
    
    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è /confirmpay"""
        try:
            message_text = update.message.text.strip()
            user_id = update.effective_user.id
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ—Ç –ª–∏ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥ username –¥–ª—è /confirmpay
            if user_id in self.confirmpay_pending_users:
                subscription_type = self.confirmpay_pending_users[user_id]
                
                # –û—á–∏—â–∞–µ–º username –æ—Ç @ –µ—Å–ª–∏ –µ—Å—Ç—å
                clean_username = message_text.replace('@', '').strip()
                
                if not clean_username:
                    await update.message.reply_text("‚ùå Username –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ username –±–µ–∑ —Å–∏–º–≤–æ–ª–∞ @")
                    return
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                confirmation_text = f"""‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–ü–õ–ê–¢–´

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{clean_username}
üíé –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏: {subscription_type}

–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?"""
                
                keyboard = [
                    [InlineKeyboardButton(
                        "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", 
                        callback_data=f"confirmpay_confirm_{clean_username}_{subscription_type}"
                    )],
                    [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="confirmpay_back")]
                ]
                reply_markup = InlineKeyboardMarkup(keyboard)
                
                await update.message.reply_text(
                    confirmation_text, 
                    reply_markup=reply_markup
                )
                
                logger.info(f"‚úÖ Username –ø–æ–ª—É—á–µ–Ω –¥–ª—è /confirmpay: @{clean_username} - {subscription_type}")
                return
            
            # –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            if "admin" in message_text.lower() and user_id in self.config.ADMIN_USER_IDS:
                await self.admin_command(update, context)
            else:
                await update.message.reply_text(
                    "ü§ñ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã"
                )
                logger.info(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_message: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    # ==============================================================================
    # –ö–û–ú–ê–ù–î–´ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –û–ü–õ–ê–¢–´ (–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï)
    # ==============================================================================
    
    async def confirm_payment_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã"""
        try:
            user = update.effective_user
            logger.info(f"–ö–û–ú–ê–ù–î–ê –ü–û–õ–£–ß–ï–ù–ê: /confirm_payment –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
            
            # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /confirmpay
            await self.confirmpay_command(update, context)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ confirm_payment_command: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def back_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞–∑–∞–¥' - –≤–æ–∑–≤—Ä–∞—Ç –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é"""
        try:
            query = update.callback_query
            await query.answer()

            welcome_text = self.config.WELCOME_MESSAGE

            keyboard = [
                [InlineKeyboardButton("üí≥ –ü–æ–¥–ø–∏—Å–∫–∏", callback_data="subscription")],
                [InlineKeyboardButton("üí¨ –°–≤—è–∑—å", callback_data="contact")],
                [InlineKeyboardButton("üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞", callback_data="referral")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.message.edit_text(welcome_text, reply_markup=reply_markup)
            logger.info(f"‚úÖ –í–æ–∑–≤—Ä–∞—Ç –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ back_callback: {e}")
            await query.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    # ==============================================================================
    # –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ (–ó–ê–ì–õ–£–®–ö–ò - –¢–†–ï–ë–£–ï–¢–°–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø)
    # ==============================================================================
    
    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞:
    # - confirm_payment_command
    # - confirmpay_command
    # - confirmpay_subscription_type_callback
    # - confirmpay_confirm_callback
    # - confirmpay_history_callback
    # - confirmpay_stats_callback
    # - confirmpay_back_callback
    # - ton_subscription_plan_callback
    # - subscription_plan_callback
    # - payment_callback
    # - activity_subscription_callback
    # - select_stars_callback
    # - select_ton_callback
    # - star_subscription_plan_callback
    # - stars_payment_callback
    # - copy_stars_ton_callback
    # - stars_payment_stars_callback
    # - referral_callback
    # - get_referral_link_callback
    # - referral_stats_callback
    # - copy_ton_callback
    # - admin_command
    # - admin_stats_command
    # - admin_people_command
    # - admin_referrals_command
    # - broadcast_command
    # - channel_info_command
    # - get_channel_id_command
    # - testcmd_command
    # - handle_message

    # ==============================================================================
    # –ö–û–ú–ê–ù–î–´ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ê–ù–ê–õ–ê–ú–ò
    # ==============================================================================
    
    async def channel_info_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /channel_info - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–∞–ª–∞—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
        try:
            user = update.effective_user
            logger.info(f"–ö–û–ú–ê–ù–î–ê –ü–û–õ–£–ß–ï–ù–ê: /channel_info –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
                return

            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            channel_data = {}
            ton_channel_data = {}
            
            # –î–∞–Ω–Ω—ã–µ –¥–ª—è Stars –ø–ª–∞—Ç–µ–∂–µ–π
            for stars, channel_id in self.config.CHANNEL_MAPPINGS.items():
                channel_data[f'stars_{stars}'] = str(channel_id)
            
            # –î–∞–Ω–Ω—ã–µ –¥–ª—è TON –ø–ª–∞—Ç–µ–∂–µ–π
            for users, channel_id in self.config.TON_CHANNEL_MAPPINGS.items():
                ton_channel_data[f'ton_{users}'] = str(channel_id)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–ª—é—á–∏ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –¥–ª—è Stars
            for stars in [25, 50, 75, 100]:
                if f'stars_{stars}' not in channel_data:
                    channel_data[f'stars_{stars}'] = "–ù–ï –ù–ê–°–¢–†–û–ï–ù"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–ª—é—á–∏ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –¥–ª—è TON
            for users in [50, 100, 150]:
                if f'ton_{users}' not in ton_channel_data:
                    ton_channel_data[f'ton_{users}'] = "–ù–ï –ù–ê–°–¢–†–û–ï–ù"
            
            logger.info(f"–î–∞–Ω–Ω—ã–µ Stars –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {channel_data}")
            logger.info(f"–î–∞–Ω–Ω—ã–µ TON –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {ton_channel_data}")
            
            # –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–ª—É—á—à–µ–Ω–Ω–æ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º Stars –∏ TON
            info_text = safe_format_user_data(
                """
**–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ò–°–¢–ï–ú–ï –ö–ê–ù–ê–õ–û–í**

**Stars –ø–ª–∞—Ç–µ–∂–∏:**
25 –∑–≤–µ–∑–¥ ‚Üí ID: `{stars_25}`
50 –∑–≤–µ–∑–¥ ‚Üí ID: `{stars_50}`
75 –∑–≤–µ–∑–¥ ‚Üí ID: `{stars_75}`
100 –∑–≤–µ–∑–¥ ‚Üí ID: `{stars_100}`

**TON –ø–ª–∞—Ç–µ–∂–∏:**
150 —Ç–æ–Ω ‚Üí ID: `{ton_150}`
100 —Ç–æ–Ω ‚Üí ID: `{ton_100}`
50 —Ç–æ–Ω ‚Üí ID: `{ton_50}`

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:**
1. –ó–∞–º–µ–Ω–∏—Ç–µ placeholder ID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ ID –∫–∞–Ω–∞–ª–æ–≤
2. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –∫–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /get_channel_id –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö ID
4. –û–±–Ω–æ–≤–∏—Ç–µ CHANNEL_MAPPINGS –∏ TON_CHANNEL_MAPPINGS –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö ID

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
CHANNEL_MAPPINGS: {diagnostic_stars}
TON_CHANNEL_MAPPINGS: {diagnostic_ton}
                """,
                **channel_data,
                **ton_channel_data,
                diagnostic_stars=str(self.config.CHANNEL_MAPPINGS),
                diagnostic_ton=str(self.config.TON_CHANNEL_MAPPINGS)
            )
            
            await update.message.reply_text(info_text, parse_mode='Markdown')
            logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /channel_info –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ channel_info_command: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã.")

    async def get_channel_id_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /get_channel_id - –ø–æ–ª—É—á–µ–Ω–∏–µ ID —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
        try:
            user = update.effective_user
            logger.info(f"–ö–û–ú–ê–ù–î–ê –ü–û–õ–£–ß–ï–ù–ê: /get_channel_id –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
                return

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ
            chat = update.effective_chat
            
            try:
                test_text = safe_format_user_data(
                    "**ID –ö–ê–ù–ê–õ–ê –ü–û–õ–£–ß–ï–ù**\n\n"
                    "**–¢–∏–ø:** {chat_type}\n"
                    "**–ù–∞–∑–≤–∞–Ω–∏–µ:** {chat_title}\n"
                    "**ID:** {chat_id}\n"
                    "**Username:** @{chat_username}\n\n"
                    "**–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!**",
                    chat_type=str(chat.type),
                    chat_title=str(chat.title or "–ù–µ —É–∫–∞–∑–∞–Ω–æ"),
                    chat_id=str(chat.id),
                    chat_username=str(chat.username or "–Ω–µ —É–∫–∞–∑–∞–Ω")
                )

                await update.message.reply_text(test_text, parse_mode='Markdown')
                logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /get_channel_id –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
                
            except Exception as format_error:
                logger.error(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ get_channel_id: {format_error}")
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                simple_info = f"""**ID –ö–ê–ù–ê–õ–ê –ü–û–õ–£–ß–ï–ù**

–¢–∏–ø: {chat.type}
–ù–∞–∑–≤–∞–Ω–∏–µ: {chat.title or '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}  
ID: {chat.id}
Username: @{chat.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}

–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"""
                await update.message.reply_text(simple_info, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ get_channel_id_command: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã.")

    async def testcmd_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /testcmd - —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
        try:
            user = update.effective_user
            logger.info(f"–ö–û–ú–ê–ù–î–ê –ü–û–õ–£–ß–ï–ù–ê: /testcmd –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞
            if user.id not in self.config.ADMIN_USER_IDS:
                await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
                return

            try:
                test_text = safe_format_user_data(
                    "**–¢–ï–°–¢–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê –í–´–ü–û–õ–ù–ï–ù–ê**\n\n"
                    "**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** {user_name}\n"
                    "**ID:** {user_id}\n"
                    "**–í—Ä–µ–º—è:** {timestamp}\n"
                    "**–ë–æ—Ç —Å—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–µ–Ω ‚úÖ\n"
                    "**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** –ü–æ–¥–∫–ª—é—á–µ–Ω–∞ ‚úÖ\n\n"
                    "**Markdown —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†–∞–±–æ—Ç–∞–µ—Ç ‚úÖ",
                    user_name=str(user.first_name or user.username or "Unknown"),
                    user_id=str(user.id),
                    timestamp=str(datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
                )

                await update.message.reply_text(test_text, parse_mode='Markdown')
                logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /testcmd –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
                
            except Exception as format_error:
                logger.error(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ testcmd: {format_error}")
                # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                simple_test = f"""–¢–ï–°–¢–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê –í–´–ü–û–õ–ù–ï–ù–ê

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.first_name or user.username or "Unknown"}
ID: {user.id}
–í—Ä–µ–º—è: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
–ë–æ—Ç —Å—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–µ–Ω ‚úÖ
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –ü–æ–¥–∫–ª—é—á–µ–Ω–∞ ‚úÖ

Markdown —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –†–∞–±–æ—Ç–∞–µ—Ç ‚úÖ"""
                await update.message.reply_text(simple_test)
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ testcmd_command: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã.")

# ==============================================================================
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ==============================================================================

async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        logger.info("üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PassiveNFT Bot ULTIMATE VERSION...")
        bot = PassiveNFTBot()
        logger.info("‚úÖ Bot –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–ø—É—Å–∫...")
        await bot.run()
    except KeyboardInterrupt:
        logger.info("üëã –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ main: {e}")
        logger.error(f"Traceback: {traceback.format_exc()}")
        raise

if __name__ == "__main__":
    try:
        logger.info("üî• –ó–ê–ü–£–°–ö PassiveNFT Bot ULTIMATE VERSION...")
        logger.info("üîß –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã")
        logger.info("‚ö° –ì–æ—Ç–æ–≤ –∫ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º")
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {e}")
        logger.error(f"Traceback: {traceback.format_exc()}")
        sys.exit(1)
